# Pullit 백엔드 스케줄러 가이드

Pullit 백엔드 시스템은 주기적으로 특정 작업을 자동으로 수행하기 위해 여러 스케줄러를 사용합니다. 각 스케줄러는 시스템의 안정성과 데이터 정합성을 유지하는 중요한 역할을 담당합니다.

모든 스케줄러는 중복 실행을 방지하기 위해 **ShedLock**을 사용하며, 일시적인 동시성 문제(낙관적 락 충돌)에 대응하기 위해 **재시도(Retry) 로직**이 적용되어 있습니다.

---

## 1. 문제집(QuestionSet) 관련 스케줄러

### 1.1 `QuestionSetCleanupScheduler`
- **목적**: 문제집 생성 과정에서 오류가 발생하여 장시간 '생성 중'(`PENDING`) 상태에 머물러 있는 문제집을 정리합니다.
- **실행 주기**: 매 10분마다 실행됩니다.
- **주요 행위**:
    1. 생성된 지 60분이 지난 `PENDING` 상태의 문제집을 모두 조회합니다.
    2. 조회된 문제집이 있다면, 해당 문제집들을 '실패'(`FAILED`) 상태로 변경합니다.
    3. 이를 통해 사용자는 문제집 생성에 문제가 발생했음을 인지하고, 시스템은 불필요하게 방치된 데이터를 정리할 수 있습니다.

### 1.2 `QuestionSetRetryScheduler`
- **목적**: 일시적인 오류로 '실패'(`FAILED`) 상태가 된 문제집의 생성을 자동으로 재시도합니다.
- **실행 주기**: 매 5분마다 실행됩니다.
- **주요 행위**:
    1. `FAILED` 상태이고, 최대 재시도 횟수(3회)를 넘지 않은 문제집을 하나 찾아옵니다.
    2. 해당 문제집의 상태를 다시 '생성 중'(`PENDING`)으로 변경하고, 재시도 횟수를 1 증가시킵니다.
    3. 문제 생성 요청 이벤트를 다시 발행하여 `QuestionGenerationWorker`가 문제 생성을 재시도하도록 합니다.

---

## 2. 학습 소스(Source) 관련 스케줄러

### 2.1 `SourceCleanupScheduler`
- **목적**: 사용자가 삭제 요청한 학습 소스 파일을 시스템에서 완전히 정리합니다.
- **실행 주기**: 매일 새벽 4시에 실행됩니다.
- **주요 행위**:
    1. 삭제 대기 상태인 학습 소스들을 조회합니다.
    2. 해당 소스와 연결된 문제집이 없는 등, 완전히 삭제 가능한 조건인지 확인합니다.
    3. 조건에 부합하는 학습 소스의 S3 파일과 관련 데이터베이스 기록을 삭제합니다.

---

## 3. 학습 통계(LearnStats) 관련 스케줄러

### 3.1 `LearnStatsScheduler`
- **목적**: 사용자의 연속 학습 기록을 매일 검증하고 업데이트합니다.
- **실행 주기**: 매일 자정(00:00)에 실행됩니다.
- **주요 행위**:
    1. 모든 회원을 대상으로 어제 학습 기록이 있는지 확인합니다.
    2. 학습 기록이 없다면 연속 학습 일수를 초기화하는 등, 데이터 정합성을 맞춥니다.

### 3.2 `LearnStatsBatchScheduler`
- **목적**: 모든 회원의 주간 학습 통계를 초기화하고, 누적 통계 데이터를 보정하는 무거운 작업을 수행합니다.
- **실행 주기**: 매주 월요일 새벽 4시에 실행됩니다.
- **주요 행위**:
    1. 모든 회원을 대상으로 `publishWeeklyReset` 이벤트를 발행하여 주간 학습 통계(예: 이번 주에 푼 문제 수)를 0으로 리셋합니다.
    2. 전체 데이터 재계산을 통해 혹시 틀어졌을 수 있는 누적 통계(예: 총 푼 문제 수)를 보정(recalibration)합니다.

---

## 4. 이벤트 및 알림 관련 스케줄러

### 4.1 `OutboxEventRelay`
- **목적**: Outbox 패턴을 사용하여, 시스템 내부에서 발생한 이벤트들을 안정적으로 최종 목적지에 전달(relay)합니다.
- **실행 주기**: 1초마다 실행됩니다.
- **주요 행위**:
    1. '발행 대기 중'인 이벤트들을 Outbox 테이블에서 조회합니다.
    2. 각 이벤트를 실제 목적지(예: 학습 통계 집계 서비스)로 전달합니다.
    3. 이벤트가 성공적으로 전달되면 Outbox 테이블에서 해당 이벤트를 삭제하여, 이벤트가 유실되거나 중복 처리되지 않도록 보장합니다.

### 4.2 `NotificationEventService` (Heartbeat)
- **목적**: SSE(Server-Sent Events)로 연결된 클라이언트와의 연결이 끊어지지 않도록 주기적으로 신호(heartbeat)를 보냅니다.
- **실행 주기**: 3초마다 실행됩니다.
- **주요 행위**:
    1. 현재 연결된 모든 SSE 클라이언트 목록을 확인합니다.
    2. 각 클라이언트에게 아무 의미 없는 더미(dummy) 이벤트를 전송합니다.
    3. 이를 통해 클라이언트와 서버 간의 연결이 유휴 상태로 인해 타임아웃되지 않도록 방지합니다.
